squeeze.rb - RuBBSのデータベースをテキスト化する

　RuBBSの全投稿を、1投稿1ファイルでメールっぽい形式のファイルに変換
するツールである。主にNamazu等でインデックスを作るために使うネタとし
て利用されることを想定。squeezeというのはバイナリからテキストを搾り
出すというつもりでつけたけど、この業界では圧縮の意味で使われることも
あるから名前としては悪い気がするけどまぁいいや。

　RuBBSのライブラリやeRubyファイルを使うので、RuBBSのインストールデ
ィレクトリと同じ場所にsqueeze.rbを置く(置けない場合は、-pオプション
でRuBBSのディレクトリを指定する)。CGIとして実行されないように、実行
属性は付けない方がいいだろう。このディレクトリをカレントにして、以
下のように実行する。

% ruby squeeze.rb <掲示板名> <出力先ディレクトリ> 

　これで、通し番号をファイル名にしたテキストファイルが<出力先ディレ
クトリ>に山ほどできる。このファイルはconf/mail.rtxtを雛形に作られて
いるので、いちおうメール形式である。ただし文字コードは実行マシンのネ
イティブコード(たぶんEUC)になっているし、Subject等はMIMEエンコードさ
れていない。Dateもできるだけ投稿時の時刻を再現するようにしてあるが、
時差分くらいの誤差はあるかも知れない。目をつぶられたし。

　オプションは以下の2つ。

    --all:
        削除した投稿も含めてテキスト化する。--allを指定しない場
        合はテキスト化しないし、すでにファイルがある場合は削除す
        る。
    --path=<RuBBS path>:
        RuBBSのインストールパスを指定する。カレントディレクトリ
        が異なる場合に指定する。

　出力しようとしているファイルがすでに存在している場合は上書きしない。
このため、cron等で毎日実行しても、差分だけが生成されるので効率的であ
ろう。でも、作者的にはメール配信をうまく使ってテキスト化するのがヨイ
と思うけどね。

　なお、squeeze.rbはデータベースファイルをロックしない。このため、同
時に投稿があった場合はあとにオープンしようとしたプロセスは失敗するで
あろう(gdbmを使った場合)。squeeze実行時にhttpdを止めるという回避策を
取っても良いだろう。まぁ、RuBBSはCGIが実行されることが極端に少ないス
クリプトなので、気にしなくてもいいかも知れない。

RuBBS: http://www.spc.gr.jp/bbs/RuBBS.html
ただただし <sho@spc.gr.jp>

